<<<<<<< SEARCH
    // Layers (New System)
    layers: Vec<ui::layers_new::CutLayer>,
    active_layer_idx: usize,
    cut_settings_state: ui::cut_settings::CutSettingsState,
=======
    // Layers (New System)
    layers: Vec<ui::layers_new::CutLayer>,
    active_layer_idx: usize,
    cut_settings_state: ui::cut_settings::CutSettingsState,
    hide_unused_layers: bool,
>>>>>>> REPLACE
<<<<<<< SEARCH
            active_layer_idx: 0,
            cut_settings_state: ui::cut_settings::CutSettingsState::default(),
            language: crate::i18n::Language::English, // Will be overridden
=======
            active_layer_idx: 0,
            cut_settings_state: ui::cut_settings::CutSettingsState::default(),
            hide_unused_layers: false,
            language: crate::i18n::Language::English, // Will be overridden
>>>>>>> REPLACE
<<<<<<< SEARCH
                    ui.separator();
                    // Show full layers list with details
                    let list_action = ui::cut_list::show(ui, &mut self.layers, self.active_layer_idx);
                    if let Some(idx) = list_action.select_layer {
=======
                    ui.separator();

                    let mut used_layers = std::collections::HashSet::new();
                    for shape in &self.drawing_state.shapes {
                        used_layers.insert(shape.layer_idx);
                    }
                    if let Some(file) = &self.loaded_file {
                        for seg in &file.segments {
                            used_layers.insert(seg.layer_id);
                        }
                    }

                    // Show full layers list with details
                    let list_action = ui::cut_list::show(ui, &mut self.layers, self.active_layer_idx, &used_layers, &mut self.hide_unused_layers);
                    if let Some(idx) = list_action.select_layer {
>>>>>>> REPLACE
<<<<<<< SEARCH
        // === CENTER: Preview ===
        CentralPanel::default().show(ctx, |ui| {
            let segments = self.loaded_file
                .as_ref()
                .map(|f| {
                    // Filter segments by layer visibility
                    f.segments.iter()
                        .filter(|seg| {
                            f.layers.get(seg.layer_id).map(|l| l.visible).unwrap_or(true)
                        })
                        .cloned()
                        .collect::<Vec<_>>()
                })
                .unwrap_or_default();
=======
        // === CENTER: Preview ===
        CentralPanel::default().show(ctx, |ui| {
            let segments = self.loaded_file
                .as_ref()
                .map(|f| {
                    // Filter segments by layer show flag (preview visibility)
                    f.segments.iter()
                        .filter(|seg| {
                            self.layers.get(seg.layer_id).map(|l| l.show).unwrap_or(true)
                        })
                        .cloned()
                        .collect::<Vec<_>>()
                })
                .unwrap_or_default();

            let preview_shapes = self.drawing_state.shapes.iter()
                .filter(|shape| {
                    self.layers.get(shape.layer_idx).map(|l| l.show).unwrap_or(true)
                })
                .cloned()
                .collect::<Vec<_>>();
>>>>>>> REPLACE
<<<<<<< SEARCH
            let preview_action = ui::preview_panel::show(
                ui,
                &mut self.renderer,
                &segments,
                &self.drawing_state.shapes,
                &self.layers,
                self.light_mode,
                offset,
                self.job_rotation,
                &mut self.camera_state
            );
=======
            let preview_action = ui::preview_panel::show(
                ui,
                &mut self.renderer,
                &segments,
                &preview_shapes,
                &self.layers,
                self.light_mode,
                offset,
                self.job_rotation,
                &mut self.camera_state
            );
>>>>>>> REPLACE
